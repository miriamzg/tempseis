 <!doctype html public "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
   <meta name="GENERATOR" content="Mozilla/4.5 [en] (X11; I; SunOS 5.6 sun4u) [Netscape]">
   <title>NAD guide</title>
</head>
<body text="#000000" background="Images/parchr.gif" LINK = "#660000"  ALINK ="#AA4400" VLINK="#AA044"> 
<A NAME="top"></A>
<table>
<tr>
<td valign="top" WIDTH=100>
<a href="http://online.anu.edu.au/">
<IMG ALIGN=LEFT  SRC="Images/anu.gif" border=0 alt="ANU online"></a> </p>
<p>&nbsp;</p><P>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<a href="http://wwwrses.anu.edu.au/">
<img src="Images/testrses.gif" border=0 alt="RSES Home Page"></A>
<p>
<FONT FACE="Georgia, Verdana, Arial, Helvetica" >

<HR WIDTH=95% SIZE=1 SHADE align=left>
<p>
<IMG SRC="Images/purcube.gif" BORDER=0 ALT="" WIDTH=7 HEIGHT=7>&nbsp;
<A href="#top">Top </a>
<p>
<IMG SRC="Images/purcube.gif" BORDER=0 ALT="" WIDTH=7 HEIGHT=7>&nbsp;
<A href="#format">Format</a>
<p>
<IMG SRC="Images/purcube.gif" BORDER=0 ALT="" WIDTH=7 HEIGHT=7>&nbsp;
<A href="#header">NAD header</a>
<p>
<br>&nbsp;<p>&nbsp;</p>
<br>&nbsp;<p>&nbsp;</p>
<br>&nbsp;<p>&nbsp;</p>
<br>&nbsp;<p>&nbsp;</p>
<p>
<IMG SRC="Images/purcube.gif" BORDER=0 ALT="" WIDTH=7 HEIGHT=7>&nbsp;
<A href="#top">Top </a>
<p>
<IMG SRC="Images/purcube.gif" BORDER=0 ALT="" WIDTH=7 HEIGHT=7>&nbsp;
<A href="#format">Format</a>
<p>
<IMG SRC="Images/purcube.gif" BORDER=0 ALT="" WIDTH=7 HEIGHT=7>&nbsp;
<A href="#header">NAD header</a>
<p>
<p>
<br>&nbsp;<p>&nbsp;</p>
<br>&nbsp;<p>&nbsp;</p>
<br>&nbsp;<p>&nbsp;</p>
<br>&nbsp;<p>&nbsp;</p>
<p>
<IMG SRC="Images/purcube.gif" BORDER=0 ALT="" WIDTH=7 HEIGHT=7>&nbsp;
<A href="#top">Top </a>
<p>
<IMG SRC="Images/purcube.gif" BORDER=0 ALT="" WIDTH=7 HEIGHT=7>&nbsp;
<A href="#format">Format</a>
<p>
<IMG SRC="Images/purcube.gif" BORDER=0 ALT="" WIDTH=7 HEIGHT=7>&nbsp;
<A href="#header">NAD header</a>
<p>
<p>
<br>&nbsp;<p>&nbsp;</p>
<br>&nbsp;<p>&nbsp;</p>
<br>&nbsp;<p>&nbsp;</p>
<br>&nbsp;<p>&nbsp;</p>
<p>
<IMG SRC="Images/purcube.gif" BORDER=0 ALT="" WIDTH=7 HEIGHT=7>&nbsp;
<A href="#top">Top </a>
<p>
<IMG SRC="Images/purcube.gif" BORDER=0 ALT="" WIDTH=7 HEIGHT=7>&nbsp;
<A href="#format">Format</a>
<p>
<IMG SRC="Images/purcube.gif" BORDER=0 ALT="" WIDTH=7 HEIGHT=7>&nbsp;
<A href="#header">NAD header</a>
<p>
<p>
</font>
</td>

<td valign="top">
&#160;&#160;&#160;&#160;&#160;&#160;

</td>
<td valign="top">

<HTML>

<BODY BGCOLOR="#FFFFFF">
<IMG SRC="Images/colorbar.gif" ALT="-----">
<H1>NAD files</H1>
<p>
</b>This page describes a NAD (Neighbourhood Algorithm Direct access) file.
This is the format in which <i>na-sampler</i> writes out all of 
the points (models) in parameter space generated by the
neighbourhood algorithm. 
<p>
A NAD file is read in by other programs which use
the models generated by <i>na-sampler</i>, 
e.g. <i>na-bayes</i> and <i>S-plot</i>. Utility programs
are included in the <i>na-sampler</i> package to read and
write NAD files. For example <i>readnad</i> reads the NAD file
and writes some summary information to the screen.
<p>
<A NAME="format"></A>
<IMG SRC="Images/colorbar.gif" ALT="-----">
<h3>Format</h3>
<p>
NAD is an unformatted direct access file consisting of 
three parts which produce a total of 
<tt>4*(nd*ne+ne+5)+nh+nhu</tt> bytes, where <tt>nd</tt> is the number of
dimensions in the parameter space (i.e. the number of variables),
<tt>ne</tt> is the number of models in the ensemble, <tt>nh</tt> is the
length in bytes of a file header, and <tt>nhu</tt> is the number of
bytes in the user portion of that file header <br>
(<tt> nhu < nh </tt>). A multi-record direct access file format is used for
compactness in storing the ensemble, and speed of I/O. 
The record length for NAD files is 4*(nd+1) bytes, and the total
number of records is <tt>mul*4*(nd+1)</tt>.
<i>FORTRAN</i> routines <i>read_nad </i> and <i>write_nad </i>
are provided for reading and writing NAD files. They write
a NAD file using the following code,
<p>
<tt>
      len = 4*(5+nd*ne+ne)+nh <br>
      open(lu,file=fnme,status='unknown',form='unformatted',<br>
      access='direct',recl=len)
<p>
      write(lu,rec=1)-mul,nd,ne,nh,nhu,header <br>
      close (lu)
<p>
      len = 4*(nd+1) <br>
      open(lu,file=fnme,status='unknown',form='unformatted',<br>
      access='direct',recl =len)
<p>
      do i = 1,ne <br>
         write(lu,rec=i+mul)(models(i,k),k=1,nd),data(i) <br>
      end do <br>
      close (lu)
<p>
</tt> 
where <tt>models</tt> is an array containing the <tt>nd*ne</tt>
real*4 variables in the ensemble, <tt>data</tt> is a real*4 array
containing the data misfit value for each model, <tt>mul</tt> is
the number of records of length <tt> 4*(nd+1) </tt> bytes
in the header and <tt>header</tt> is a
character string of length <tt> nh </tt> containing other information.
<p>
<A NAME="header"></A>
<h4> Two parts to the header</h4>
<p>
The header block is split into two parts. The first contains <tt>nh-nhu</tt>
bytes and is reserved for use by the NA-programs. The second 
 is provided so that the user may write information into a NAD header,
e.g date, run details etc. In this way
users may make use of NAD files in their own analysis programs etc.
The length of the user header is <tt>nhu</tt> bytes and is written in 
the user subroutine <i> writemodels</i> supplied to the 
program <i>na-sampler</i>. The user portion of the header may be of 
any length including zero. If you do not wish to use NAD files in
your own programs then the simplest thing to do in subroutine 
<i> writemodels </i> is to return the length of the user NAD header as zero
(i.e. set <tt>nhu=0</tt>).
<p>
<h5> Writing a NAD header (user's part) </h5>
For example a FORTRAN subroutine
that writes the real*4 array <tt>mydata(100)</tt> and the 
integers <tt> n1,n2 </tt> and <tt> n3 </tt> into the header, could look 
like this
<p>
<tt>
      Subroutine (header,nhu,mydata,n1,n2,n3) <br>
      real*4	mydata(100) <br>
      character	header(412) <br>
<p>
      nhu = 4*(3+100) <br>
      open(lu,file='naduser',status='unknown',form='unformatted',
access='direct',recl=nhu) <br>
      write(lu,rec=1)n1,n2,n3,mydata <br>
      close(lu) <br>
<p>
      open(lu,file='naduser',status='unknown',form='unformatted',
access='direct',recl=nhu) <br>
      read(lu,rec=1)header <br>
      close(lu) <br>
      return
</tt>
<p>
Note that the user variables are first written out to a direct access
file and then read back in again into the character string <tt>header</tt>,
which is returned to the main program. In the program <i>na-sampler</i>
the internal header string is then added to the front of this character
string.
<p>  
The same array variables could be read back from the temporary 
file <i>'naduser'</i>
with FORTRAN code like this.
<p>
<tt>
      real*4	mydata(100) 
<p>
      len = 4*(3+100)
<p>
      open(lu,file=fnme,status='unknown',form='unformatted',access='direct',recl=len)
<p>
      write(lu,rec=1)hdummy
<p>
</tt>
where <tt>hdummy</tt> is a character string of length <tt>nh-nhu</tt> bytes.
The reserved portion of the header is built in a similar manner. Note that
it is allowed that <tt>nhu = 0</tt>, which means that the user portion of the
header file is empty.
<p>
<h5> Format of the reserved portion of the NAD header </h5>
The reserved portion of a NAD header file is used to pass information
to other programs that make use of NAD files. For example the programs
in the package NA-bayes (i.e. nab.f and naplot.f). Currently 
the reserved header portion is read from the nad file with the following 
f77 code. 
<p>
<tt>
      real*4	range(2,nd) 
<p>
      real*4	scales(nd+1) 
<p>
      len = 4*(8+3*nd)
<p>
      open(lu,file=fnme,status='old',form='unformatted',access='direct',recl=len)
<p>
      read(lu,rec=1)-mul,nd,ne,nh,nhu,ns1,ns,nr,range,scales
<p>
</tt>
Note that the last 4 variables (i.e. 4*(1+3*nd) bytes) define the format
of the reserved NAD header. We call it `reserved' because the user
is not allowed to change it, however it may be necessary for the user
to know its format if writing ones own NAD files, e.g. for input into
NA-bayes. At the present time the reserved NAD header simply
contains the definition of the parameter space ranges, scale factors
and the three parameters ns1,ns and nr used in the NA sampler program.
<p>
Note the program nab.f in NA-bayes gets the definition of the parameter
space ranges from this NAD file. <b> Note that </b> the format of the 
reserved portion of the NAD header may change in the future, however,
its size will always be set at nh-nhu and so it can always be skipped
over when reading NAD files.
<p>
<IMG SRC="Images/colorbar.gif" ALT="-----">
<p>
Related sites:

<ul>
<li><a href="http://rses.anu.edu.au/~malcolm/NA/na.html">NA homepage</a> 
(where NA programs can be downloaded)</li>

<li><a href="http://rses.anu.edu.au/~malcolm">Malcolm's homepage</a> </li>

</ul>

<IMG SRC="Images/colorbar.gif" ALT="-----"><br>
<br>Enquires to Malcolm Sambridge: <A HREF="mailto:malcolm@rses.anu.edu.au">
<EM>malcolm@rses.anu.edu.au</EM></A><br>
<IMG SRC="Images/colorbar.gif" ALT="-----">


</td>
</tr>
</table>

</body>
</html>

